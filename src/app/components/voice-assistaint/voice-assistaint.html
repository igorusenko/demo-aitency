<div id="chat">
  @if (showEmptyState) {
    <div class="empty-state">
      <div class="empty-state-icon">üéôÔ∏è</div>
      <div class="empty-state-text">–ì–æ–ª–æ—Å–æ–≤–æ–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –≥–æ—Ç–æ–≤</div>
      <div class="empty-state-hint">
        –ù–∞–∂–º–∏—Ç–µ –Ω–∞ –∫–Ω–æ–ø–∫—É –º–∏–∫—Ä–æ—Ñ–æ–Ω–∞, —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å —Ä–∞–∑–≥–æ–≤–æ—Ä
      </div>
    </div>
  }
  @for (msg of messages; track msg) {
    <div [class]="'msg ' + msg.who">
      {{ msg.text }}
    </div>
  }

</div>

<div class="controls">
  <div class="recording-indicator" [class.active]="isRecording">
    <div class="recording-dot"></div>
    <span>–ò–¥–µ—Ç –∑–∞–ø–∏—Å—å...</span>
  </div>

  <button
    class="recordBtn"
    title="–ù–∞–∂–º–∏—Ç–µ –¥–ª—è –∑–∞–ø–∏—Å–∏ –≥–æ–ª–æ—Å–∞"
    [class.recording]="isRecording"
    (click)="toggleRecording()"
  >
    {{ isRecording ? '‚èπÔ∏è' : 'üé§' }}
  </button>
</div>

<audio #player preload="auto"></audio>

<!--<script>-->
<!--  // URL WS-—Å–µ—Ä–≤–µ—Ä–∞. –ë—ã—Å—Ç—Ä–æ –ø–µ—Ä–µ–∫–ª—é—á–∞–µ–º—Å—è –º–µ–∂–¥—É –ª–æ–∫–∞–ª—å–Ω—ã–º –∏ –ø—Ä–æ–¥–æ–º.-->
<!--  const REMOTE_WS_URL = 'wss://voice-116.aitency.net/realtime';-->
<!--  const LOCAL_WS_URL = 'ws://localhost:3000/realtime';-->
<!--  const params = new URLSearchParams(window.location.search);-->
<!--  const urlOverride = params.get('ws');-->
<!--  const modeOverride = params.get('backend'); // local | remote-->
<!--  const savedMode = localStorage.getItem('backendMode'); // local | remote-->

<!--  function resolveWsUrl() {-->
<!--    if (urlOverride) return urlOverride;-->
<!--    const mode = modeOverride || savedMode;-->
<!--    if (mode === 'local') return LOCAL_WS_URL;-->
<!--    if (mode === 'remote') return REMOTE_WS_URL;-->
<!--    // –§–æ–ª–ª–±–µ–∫: –µ—Å–ª–∏ —Å—Ç—Ä–∞–Ω–∏—Ü–∞ —Å –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —Ö–æ—Å—Ç–∞ ‚Äî —Ö–æ–¥–∏–º –ª–æ–∫–∞–ª—å–Ω–æ, –∏–Ω–∞—á–µ ‚Äî –Ω–∞ –ø—Ä–æ–¥-->
<!--    if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {-->
<!--      return LOCAL_WS_URL;-->
<!--    }-->
<!--    return REMOTE_WS_URL;-->
<!--  }-->

<!--  const STREAMING_SERVER_URL = resolveWsUrl();-->
<!--  localStorage.setItem('backendMode', modeOverride || savedMode || (STREAMING_SERVER_URL === LOCAL_WS_URL ? 'local' : 'remote'));-->

<!--  console.log('WS URL:', STREAMING_SERVER_URL);-->

<!--  let mediaRecorder;-->
<!--  let ws;-->
<!--  let isRecording = false;-->
<!--  let audioContext = null;-->
<!--  let audioSource = null;-->
<!--  let audioProcessor = null;-->
<!--  let micStream = null;-->

<!--  // === PLAYBACK FOR REALTIME PCM AUDIO ===-->
<!--  let playbackContext = null;-->
<!--  let audioQueue = [];-->
<!--  let isPlaying = false;-->
<!--  let playbackTime = 0; // –í—Ä–µ–º—è, –Ω–∞ –∫–æ—Ç–æ—Ä–æ–µ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–æ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ —Å–ª–µ–¥—É—é—â–µ–≥–æ —á–∞–Ω–∫–∞-->
<!--  let currentAudioSources = []; // –ê–∫—Ç–∏–≤–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –∞—É–¥–∏–æ –¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏-->
<!--  let lastResponseItemId = null; // ID –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –æ—Ç–≤–µ—Ç–∞ –¥–ª—è truncate-->
<!--  let playbackStartTime = 0; // –í—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è —Ç–µ–∫—É—â–µ–≥–æ –æ—Ç–≤–µ—Ç–∞-->

<!--  function initPlaybackContext() {-->
<!--    if (!playbackContext || playbackContext.state === 'closed') {-->
<!--      playbackContext = new AudioContext({ sampleRate: 24000 });-->
<!--      console.log('AudioContext created, state:', playbackContext.state);-->
<!--    }-->
<!--    if (playbackContext.state === 'suspended') {-->
<!--      playbackContext.resume().then(() => {-->
<!--        console.log('AudioContext resumed, state:', playbackContext.state);-->
<!--      }).catch(err => {-->
<!--        console.error('Failed to resume AudioContext:', err);-->
<!--      });-->
<!--    }-->
<!--  }-->

<!--  function stopAllPlayback() {-->
<!--    // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Å–µ –∞–∫—Ç–∏–≤–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏ –∞—É–¥–∏–æ-->
<!--    currentAudioSources.forEach(source => {-->
<!--      try {-->
<!--        source.stop();-->
<!--      } catch (e) {-->
<!--        // –ò—Å—Ç–æ—á–Ω–∏–∫ —É–∂–µ –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω-->
<!--      }-->
<!--    });-->
<!--    currentAudioSources = [];-->
<!--    audioQueue = [];-->
<!--    isPlaying = false;-->
<!--    playbackTime = 0;-->
<!--  }-->

<!--  function enqueueAudioChunk(pcm16buffer) {-->
<!--    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –¥–∞–Ω–Ω—ã–µ –≤–∞–ª–∏–¥–Ω—ã –¥–ª—è PCM16 (–¥–ª–∏–Ω–∞ –¥–æ–ª–∂–Ω–∞ –±—ã—Ç—å –∫—Ä–∞—Ç–Ω–∞ 2 –±–∞–π—Ç–∞–º)-->
<!--    if (!pcm16buffer || pcm16buffer.byteLength === 0) {-->
<!--      console.warn('Empty or invalid audio chunk received');-->
<!--      return;-->
<!--    }-->

<!--    if (pcm16buffer.byteLength % 2 !== 0) {-->
<!--      console.warn('Audio chunk length is not multiple of 2, skipping:', pcm16buffer.byteLength);-->
<!--      return;-->
<!--    }-->

<!--    // –ú–∏–Ω–∏–º–∞–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞: –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Ö–æ—Ç—è –±—ã –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å—ç–º–ø–ª–æ–≤-->
<!--    if (pcm16buffer.byteLength < 100) {-->
<!--      console.warn('Audio chunk too small, skipping:', pcm16buffer.byteLength);-->
<!--      return;-->
<!--    }-->

<!--    initPlaybackContext();-->

<!--    // –£–±–µ–∂–¥–∞–µ–º—Å—è, —á—Ç–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç –∞–∫—Ç–∏–≤–µ–Ω –ø–µ—Ä–µ–¥ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º –≤ –æ—á–µ—Ä–µ–¥—å-->
<!--    if (playbackContext.state === 'suspended') {-->
<!--      playbackContext.resume().then(() => {-->
<!--        console.log('AudioContext resumed before enqueue, state:', playbackContext.state);-->
<!--        audioQueue.push(pcm16buffer);-->
<!--        console.log('Audio chunk enqueued after resume, queue length:', audioQueue.length, 'isPlaying:', isPlaying);-->
<!--        if (!isPlaying) {-->
<!--          playbackTime = playbackContext.currentTime;-->
<!--          playNextChunk();-->
<!--        }-->
<!--      }).catch(err => {-->
<!--        console.error('Failed to resume AudioContext:', err);-->
<!--      });-->
<!--      return;-->
<!--    }-->

<!--    audioQueue.push(pcm16buffer);-->
<!--    console.log('Audio chunk enqueued, queue length:', audioQueue.length, 'isPlaying:', isPlaying, 'context state:', playbackContext.state);-->
<!--    if (!isPlaying) {-->
<!--      playbackTime = playbackContext.currentTime;-->
<!--      playNextChunk();-->
<!--    }-->
<!--  }-->

<!--  function playNextChunk() {-->
<!--    if (audioQueue.length === 0) {-->
<!--      isPlaying = false;-->
<!--      console.log('Audio queue empty, stopping playback');-->
<!--      return;-->
<!--    }-->

<!--    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç –∞–∫—Ç–∏–≤–µ–Ω-->
<!--    if (!playbackContext || playbackContext.state === 'closed') {-->
<!--      console.error('PlaybackContext is closed, cannot play chunk');-->
<!--      audioQueue = [];-->
<!--      isPlaying = false;-->
<!--      return;-->
<!--    }-->

<!--    if (playbackContext.state === 'suspended') {-->
<!--      playbackContext.resume().then(() => {-->
<!--        console.log('AudioContext resumed in playNextChunk');-->
<!--        playNextChunk(); // –ü–æ–≤—Ç–æ—Ä—è–µ–º –ø–æ–ø—ã—Ç–∫—É –ø–æ—Å–ª–µ –≤–æ–∑–æ–±–Ω–æ–≤–ª–µ–Ω–∏—è-->
<!--      }).catch(err => {-->
<!--        console.error('Failed to resume AudioContext in playNextChunk:', err);-->
<!--      });-->
<!--      return;-->
<!--    }-->

<!--    isPlaying = true;-->

<!--    const chunk = audioQueue.shift();-->
<!--    console.log('Playing chunk, size:', chunk.byteLength, 'remaining in queue:', audioQueue.length);-->

<!--    // –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º Int16Array-->
<!--    if (chunk.byteLength % 2 !== 0) {-->
<!--      console.warn('Skipping invalid chunk in playNextChunk:', chunk.byteLength);-->
<!--      playNextChunk(); // –ü—Ä–æ–ø—É—Å–∫–∞–µ–º —ç—Ç–æ—Ç —á–∞–Ω–∫ –∏ –ø–µ—Ä–µ—Ö–æ–¥–∏–º –∫ —Å–ª–µ–¥—É—é—â–µ–º—É-->
<!--      return;-->
<!--    }-->

<!--    // –ß–∏—Ç–∞–µ–º PCM16 –¥–∞–Ω–Ω—ã–µ-->
<!--    const dataView = new DataView(chunk);-->
<!--    const sampleCount = chunk.byteLength / 2;-->
<!--    const float32 = new Float32Array(sampleCount);-->

<!--    // –ö–æ–Ω–≤–µ—Ä—Ç–∞—Ü–∏—è Int16 –≤ Float32-->
<!--    // –ü—Ä–æ–±—É–µ–º little-endian (—Å—Ç–∞–Ω–¥–∞—Ä—Ç –¥–ª—è PCM16)-->
<!--    let maxValue = 0;-->
<!--    let minValue = 0;-->

<!--    for (let i = 0; i < sampleCount; i++) {-->
<!--      // –ß–∏—Ç–∞–µ–º Int16 —Å little-endian –ø–æ—Ä—è–¥–∫–æ–º –±–∞–π—Ç–æ–≤-->
<!--      const int16Value = dataView.getInt16(i * 2, true);-->

<!--      // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –≤ –¥–∏–∞–ø–∞–∑–æ–Ω [-1.0, 1.0]-->
<!--      float32[i] = int16Value / 32768.0;-->

<!--      // –û—Ç—Å–ª–µ–∂–∏–≤–∞–µ–º –¥–∏–∞–ø–∞–∑–æ–Ω –∑–Ω–∞—á–µ–Ω–∏–π –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏-->
<!--      if (int16Value > maxValue) maxValue = int16Value;-->
<!--      if (int16Value < minValue) minValue = int16Value;-->

<!--      // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏—è-->
<!--      if (float32[i] > 1.0) float32[i] = 1.0;-->
<!--      if (float32[i] < -1.0) float32[i] = -1.0;-->
<!--    }-->

<!--    // –£–±—Ä–∞–ª–∏ fade-in/out, —Ç–∞–∫ –∫–∞–∫ –æ–Ω –¥–µ–ª–∞–µ—Ç –≥–æ–ª–æ—Å –Ω–µ—Ä–æ–≤–Ω—ã–º-->
<!--    // –í–º–µ—Å—Ç–æ —ç—Ç–æ–≥–æ –ø–æ–ª–∞–≥–∞–µ–º—Å—è –Ω–∞ –ø—Ä–∞–≤–∏–ª—å–Ω—É—é —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—é —á–∞–Ω–∫–æ–≤-->

<!--    // –õ–æ–≥–∏—Ä—É–µ–º –ø–µ—Ä–≤—ã–µ –Ω–µ—Å–∫–æ–ª—å–∫–æ —Å—ç–º–ø–ª–æ–≤ –¥–ª—è –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–∏ (—Ç–æ–ª—å–∫–æ –¥–ª—è –ø–µ—Ä–≤—ã—Ö —á–∞–Ω–∫–æ–≤)-->
<!--    if (audioQueue.length === 0 && sampleCount > 0) {-->
<!--      console.log('Audio chunk stats:', {-->
<!--        samples: sampleCount,-->
<!--        duration: (sampleCount / 24000).toFixed(3) + 's',-->
<!--        int16Range: `[${minValue}, ${maxValue}]`,-->
<!--        firstSamples: Array.from(float32.slice(0, 5)).map(v => v.toFixed(4))-->
<!--      });-->
<!--    }-->

<!--    const buffer = playbackContext.createBuffer(1, float32.length, 24000);-->
<!--    buffer.copyToChannel(float32, 0);-->

<!--    const source = playbackContext.createBufferSource();-->
<!--    source.buffer = buffer;-->
<!--    source.connect(playbackContext.destination);-->

<!--    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫ –¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ –ø—Ä–∏ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏–∏-->
<!--    currentAudioSources.push(source);-->

<!--    // –í—ã—á–∏—Å–ª—è–µ–º –¥–ª–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å —á–∞–Ω–∫–∞ –≤ —Å–µ–∫—É–Ω–¥–∞—Ö-->
<!--    const duration = buffer.duration;-->

<!--    // –í—ã—Ä–∞–≤–Ω–∏–≤–∞–µ–º —Ä–∞—Å–ø–∏—Å–∞–Ω–∏–µ: –µ—Å–ª–∏ –æ—Ç—Å—Ç–∞–ª–∏ –æ—Ç currentTime ‚Äî –Ω–∞—á–∏–Ω–∞–µ–º —Å—Ä–∞–∑—É-->
<!--    const startAt = Math.max(playbackTime, playbackContext.currentTime);-->

<!--    // –ó–∞–ø–æ–º–∏–Ω–∞–µ–º –≤—Ä–µ–º—è –Ω–∞—á–∞–ª–∞ –ø–µ—Ä–≤–æ–≥–æ —á–∞–Ω–∫–∞ –¥–ª—è truncate-->
<!--    if (currentAudioSources.length === 1) {-->
<!--      playbackStartTime = startAt;-->
<!--    }-->

<!--    try {-->
<!--      source.start(startAt);-->
<!--      console.log('Audio source started at:', startAt, 'duration:', duration.toFixed(3), 's');-->
<!--    } catch (err) {-->
<!--      console.error('Failed to start audio source:', err);-->
<!--      // –£–¥–∞–ª—è–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫ –∏–∑ —Å–ø–∏—Å–∫–∞ –∏ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º —Å–æ —Å–ª–µ–¥—É—é—â–∏–º —á–∞–Ω–∫–æ–º-->
<!--      const index = currentAudioSources.indexOf(source);-->
<!--      if (index > -1) {-->
<!--        currentAudioSources.splice(index, 1);-->
<!--      }-->
<!--      playNextChunk();-->
<!--      return;-->
<!--    }-->

<!--    // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ —á–∞–Ω–∫–∞-->
<!--    playbackTime = startAt + duration;-->

<!--    source.onended = () => {-->
<!--      console.log('Audio chunk finished playing');-->
<!--      // –£–¥–∞–ª—è–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫ –∏–∑ —Å–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–Ω—ã—Ö-->
<!--      const index = currentAudioSources.indexOf(source);-->
<!--      if (index > -1) {-->
<!--        currentAudioSources.splice(index, 1);-->
<!--      }-->
<!--      playNextChunk();-->
<!--    };-->

<!--    source.onerror = (err) => {-->
<!--      console.error('Audio source error:', err);-->
<!--      const index = currentAudioSources.indexOf(source);-->
<!--      if (index > -1) {-->
<!--        currentAudioSources.splice(index, 1);-->
<!--      }-->
<!--      playNextChunk();-->
<!--    };-->
<!--  }-->

<!--  const chat = document.getElementById("chat");-->
<!--  const recBtn = document.getElementById("recordBtn");-->
<!--  const player = document.getElementById("player");-->

<!--  // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è sessionId-->
<!--  let sessionId = localStorage.getItem('sessionId');-->
<!--  if (!sessionId) {-->
<!--    sessionId = crypto.randomUUID();-->
<!--    localStorage.setItem('sessionId', sessionId);-->
<!--  }-->

<!--  function addMessage(text, who) {-->
<!--    // –°–∫—Ä—ã–≤–∞–µ–º –ø—É—Å—Ç–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏-->
<!--    const emptyState = document.getElementById("emptyState");-->
<!--    if (emptyState) {-->
<!--      emptyState.style.display = "none";-->
<!--    }-->

<!--    const div = document.createElement("div");-->
<!--    div.className = "msg " + who;-->
<!--    div.textContent = text;-->
<!--    chat.appendChild(div);-->
<!--    chat.scrollTop = chat.scrollHeight;-->
<!--    return div;-->
<!--  }-->

<!--  function addStatus(text) {-->
<!--    const div = document.createElement("div");-->
<!--    div.className = "status";-->
<!--    div.innerHTML = `<span class="loading"></span> ${text}`;-->
<!--    chat.appendChild(div);-->
<!--    chat.scrollTop = chat.scrollHeight;-->
<!--    return div;-->
<!--  }-->

<!--  // –ü—Ä–æ—Å—Ç–∞—è —Ä–∞–±–æ—Ç–∞ —Å WS-—Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ–º-->
<!--  function ensureWebSocket() {-->
<!--    if (ws && ws.readyState === WebSocket.OPEN) return ws;-->

<!--    ws = new WebSocket(STREAMING_SERVER_URL);-->

<!--    ws.binaryType = 'arraybuffer';-->

<!--    ws.onopen = () => {-->
<!--      console.log('WS connected');-->
<!--    };-->

<!--    ws.onclose = () => {-->
<!--      console.log('WS closed');-->
<!--    };-->

<!--    ws.onerror = (e) => {-->
<!--      console.error('WS error', e);-->
<!--    };-->

<!--    ws.onmessage = (event) => {-->
<!--      if (event.data instanceof ArrayBuffer) {-->
<!--        console.log('Received binary audio data:', event.data.byteLength, 'bytes');-->
<!--        enqueueAudioChunk(event.data);-->
<!--        return;-->
<!--      }-->

<!--      // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —Å–æ–±—ã—Ç–∏—è Realtime API –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–µ–∫—Å—Ç-->
<!--      if (typeof event.data === 'string') {-->
<!--        try {-->
<!--          const msg = JSON.parse(event.data);-->
<!--          console.log('WS EVENT FROM OPENAI:', msg);-->

<!--          // –ü—Ä–∏ –Ω–∞—á–∞–ª–µ –Ω–æ–≤–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ –æ—á–∏—â–∞–µ–º –æ—á–µ—Ä–µ–¥—å –∞—É–¥–∏–æ-->
<!--          if (msg.type === 'response.created') {-->
<!--            console.log('Response created, stopping previous playback');-->
<!--            stopAllPlayback();-->
<!--            lastResponseItemId = msg.response?.id || null;-->
<!--            playbackStartTime = 0;-->
<!--            // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –Ω–æ–≤–æ–≥–æ –æ—Ç–≤–µ—Ç–∞-->
<!--            initPlaybackContext();-->
<!--            console.log('New response started, cleared audio queue, context state:', playbackContext?.state);-->
<!--          }-->

<!--          // –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—Ä–µ—Ä—ã–≤–∞–Ω–∏—è - –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞—á–∞–ª –≥–æ–≤–æ—Ä–∏—Ç—å –≤–æ –≤—Ä–µ–º—è –æ—Ç–≤–µ—Ç–∞ –º–æ–¥–µ–ª–∏-->
<!--          if (msg.type === 'input_audio_buffer.speech_started') {-->
<!--            console.log('User started speaking, interrupting playback');-->
<!--            stopAllPlayback();-->
<!--            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º truncate –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è –Ω–µ–ø—Ä–æ–∏–≥—Ä–∞–Ω–Ω–æ–≥–æ –∞—É–¥–∏–æ –∏–∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞-->
<!--            if (lastResponseItemId && ws && ws.readyState === WebSocket.OPEN && playbackContext) {-->
<!--              const playedDuration = Math.max(0, (playbackContext.currentTime - playbackStartTime) * 1000);-->
<!--              if (playedDuration > 0) {-->
<!--                ws.send(JSON.stringify({-->
<!--                  type: 'conversation.item.truncate',-->
<!--                  item_id: lastResponseItemId,-->
<!--                  content_index: 0,-->
<!--                  audio_end_ms: Math.floor(playedDuration)-->
<!--                }));-->
<!--                console.log(`Truncated response ${lastResponseItemId} at ${Math.floor(playedDuration)}ms`);-->
<!--              }-->
<!--            }-->
<!--          }-->

<!--          // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–º–µ–Ω—ã –æ—Ç–≤–µ—Ç–∞-->
<!--          if (msg.type === 'response.cancelled') {-->
<!--            console.log('Response cancelled by server');-->
<!--            stopAllPlayback();-->
<!--          }-->

<!--          // –°–æ—Ö—Ä–∞–Ω—è–µ–º ID —ç–ª–µ–º–µ–Ω—Ç–∞ –æ—Ç–≤–µ—Ç–∞ –¥–ª—è –≤–æ–∑–º–æ–∂–Ω–æ–≥–æ truncate-->
<!--          if (msg.type === 'response.output_item.added' && msg.item?.id) {-->
<!--            lastResponseItemId = msg.item.id;-->
<!--          }-->

<!--          // –¢–∞–∫–∂–µ –ø–æ–ª—É—á–∞–µ–º ID –∏–∑ response.done (–Ω–∞ —Å–ª—É—á–∞–π, –µ—Å–ª–∏ output_item.added –Ω–µ –ø—Ä–∏—à–ª–æ)-->
<!--          if (msg.type === 'response.done' && msg.response?.output?.[0]?.id) {-->
<!--            lastResponseItemId = msg.response.output[0].id;-->
<!--          }-->

<!--          // –£–ø—Ä–æ—â—ë–Ω–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞ —Å –≥–æ—Ç–æ–≤—ã–º —Ç–µ–∫—Å—Ç–æ–º-->
<!--          if (msg.type === 'assistant.text' && msg.text) {-->
<!--            addMessage(msg.text, "assistant");-->
<!--            return;-->
<!--          }-->

<!--          if (msg.type === 'response.output_text.delta' && msg.delta) {-->
<!--            console.log('TEXT DELTA:', msg.delta);-->
<!--          }-->

<!--          if (msg.type === 'response.output_text.done' && msg.output && msg.output[0]?.content?.[0]?.text) {-->
<!--            const finalText = msg.output[0].content[0].text;-->
<!--            addMessage(finalText, "assistant");-->
<!--          }-->
<!--        } catch (e) {-->
<!--          console.warn('Non-JSON text message', event.data);-->
<!--        }-->
<!--      }-->
<!--    };-->

<!--    return ws;-->
<!--  }-->

<!--  // –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ Float32 [-1,1] –≤ Int16 PCM, —Å –ø—Ä–æ—Å—Ç—ã–º –¥–∞—É–Ω-—Å–µ–º–ø–ª–∏–Ω–≥–æ–º 48k -> 24k –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏-->
<!--  function floatTo16BitPCM(input, originalSampleRate) {-->
<!--    let data = input;-->
<!--    if (originalSampleRate === 48000) {-->
<!--      const newLength = Math.floor(input.length / 2);-->
<!--      const down = new Float32Array(newLength);-->
<!--      for (let i = 0, j = 0; j < newLength; i += 2, j++) {-->
<!--        down[j] = input[i];-->
<!--      }-->
<!--      data = down;-->
<!--    }-->

<!--    const buffer = new ArrayBuffer(data.length * 2);-->
<!--    const view = new DataView(buffer);-->
<!--    let offset = 0;-->
<!--    for (let i = 0; i < data.length; i++, offset += 2) {-->
<!--      let s = Math.max(-1, Math.min(1, data[i]));-->
<!--      view.setInt16(offset, s < 0 ? s * 0x8000 : s * 0x7FFF, true);-->
<!--    }-->
<!--    return buffer;-->
<!--  }-->

<!--  recBtn.onclick = async () => {-->
<!--    const wsConn = ensureWebSocket();-->

<!--    // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º AudioContext –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–∏ (—Ç—Ä–µ–±–æ–≤–∞–Ω–∏–µ –±—Ä–∞—É–∑–µ—Ä–æ–≤)-->
<!--    initPlaybackContext();-->
<!--    if (playbackContext && playbackContext.state === 'suspended') {-->
<!--      await playbackContext.resume();-->
<!--      console.log('AudioContext activated on user interaction');-->
<!--    }-->

<!--    if (isRecording) {-->
<!--      // –°—Ç–æ–ø –∑–∞–ø–∏—Å–∏-->
<!--      isRecording = false;-->
<!--      recBtn.classList.remove("recording");-->
<!--      recBtn.textContent = "üé§";-->

<!--      // –°–∫—Ä—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–ø–∏—Å–∏-->
<!--      const recordingIndicator = document.getElementById("recordingIndicator");-->
<!--      if (recordingIndicator) {-->
<!--        recordingIndicator.classList.remove("active");-->
<!--      }-->

<!--      // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –æ—Ç–≤–µ—Ç–æ–≤ –ø—Ä–∏ –æ—Å—Ç–∞–Ω–æ–≤–∫–µ –∑–∞–ø–∏—Å–∏-->
<!--      stopAllPlayback();-->

<!--      if (audioProcessor && audioSource) {-->
<!--        audioSource.disconnect(audioProcessor);-->
<!--        audioProcessor.disconnect(audioContext.destination);-->
<!--      }-->
<!--      if (micStream) {-->
<!--        micStream.getTracks().forEach(t => t.stop());-->
<!--      }-->
<!--      return;-->
<!--    }-->

<!--    try {-->
<!--      const stream = await navigator.mediaDevices.getUserMedia({-->
<!--        audio: {-->
<!--          echoCancellation: true,-->
<!--          noiseSuppression: true,-->
<!--          autoGainControl: true-->
<!--        }-->
<!--      });-->

<!--      micStream = stream;-->

<!--      if (!audioContext) {-->
<!--        audioContext = new (window.AudioContext || window.webkitAudioContext)();-->
<!--      }-->

<!--      const source = audioContext.createMediaStreamSource(stream);-->
<!--      const processor = audioContext.createScriptProcessor(4096, 1, 1);-->

<!--      processor.onaudioprocess = function (e) {-->
<!--        if (!isRecording || wsConn.readyState !== WebSocket.OPEN) return;-->
<!--        const inputBuffer = e.inputBuffer.getChannelData(0);-->
<!--        const pcmBuffer = floatTo16BitPCM(inputBuffer, audioContext.sampleRate);-->
<!--        wsConn.send(pcmBuffer);-->
<!--      };-->

<!--      source.connect(processor);-->
<!--      processor.connect(audioContext.destination);-->

<!--      audioSource = source;-->
<!--      audioProcessor = processor;-->

<!--      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–ø–∏—Å–∏-->
<!--      const recordingIndicator = document.getElementById("recordingIndicator");-->
<!--      if (recordingIndicator) {-->
<!--        recordingIndicator.classList.add("active");-->
<!--      }-->

<!--      isRecording = true;-->
<!--      recBtn.classList.add("recording");-->
<!--      recBtn.textContent = "‚èπÔ∏è";-->

<!--    } catch (error) {-->
<!--      console.error('Error accessing microphone:', error);-->
<!--      addMessage("‚ùå –û—à–∏–±–∫–∞ –¥–æ—Å—Ç—É–ø–∞ –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É", "assistant");-->
<!--    }-->
<!--  };-->
<!--</script>-->
